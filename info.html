<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informations - Mariage</title>
    <link rel="stylesheet" href="app.css">
    <style>
        .alert-section {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(238, 90, 111, 0.3);
            animation: pulse-alert 2s ease-in-out infinite;
        }

        .alert-section h2 {
            color: white;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border-left: 4px solid white;
            animation: slideIn 0.5s ease-out;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-time {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .alert-message {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .no-alerts {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        @keyframes pulse-alert {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(238, 90, 111, 0.3);
            }
            50% {
                box-shadow: 0 10px 40px rgba(238, 90, 111, 0.5);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="icon">‚ÑπÔ∏è</div>
            <h1>Informations Pratiques</h1>
            <p class="subtitle">Tout ce qu'il faut savoir pour cette journ√©e</p>
            <a href="#" id="backButton" class="back-button">‚Üê Retour √† l'accueil</a>
        </div>

        <!-- Section des alertes en temps r√©el -->
        <div id="alertsSection" style="display: none;">
            <div class="alert-section">
                <h2>
                    <span style="font-size: 1.5em;">üîî</span>
                    Alertes & Annonces
                </h2>
                <div id="alertsList">
                    <!-- Les alertes seront charg√©es ici -->
                </div>
            </div>
        </div>

        <div id="infoContent">
            <!-- Le contenu sera charg√© dynamiquement -->
        </div>
    </div>

    <script>
        // Informations statiques par d√©faut
        const DEFAULT_INFO = [
            {
                id: 'lieu',
                icon: 'üìç',
                title: 'Lieu de r√©ception',
                content: `
                    <strong>Domaine des Roses</strong><br>
                    123 Avenue des Fleurs<br>
                    75000 Paris, France<br><br>
                    <a href="https://maps.google.com" target="_blank" style="color: #e74c3c;">üìç Voir sur Google Maps</a>
                `
            },
            {
                id: 'parking',
                icon: 'üöó',
                title: 'Stationnement',
                content: `
                    Un parking gratuit de 150 places est disponible sur place.<br>
                    Entr√©e par l'avenue principale.<br>
                    Service de voiturier disponible de 14h √† 3h du matin.
                `
            },
            {
                id: 'transport',
                icon: 'üöå',
                title: 'Transports',
                content: `
                    <strong>En transports en commun :</strong><br>
                    ‚Ä¢ M√©tro ligne 7, arr√™t "Mairie"<br>
                    ‚Ä¢ Bus 42 et 67<br><br>
                    <strong>Navettes :</strong><br>
                    Des navettes seront disponibles :<br>
                    ‚Ä¢ D√©part : 1h00 et 2h00<br>
                    ‚Ä¢ Destination : Gare centrale et H√¥tel Ibis
                `
            },
            {
                id: 'hebergement',
                icon: 'üè®',
                title: 'H√©bergement',
                content: `
                    <strong>H√¥tels recommand√©s √† proximit√© :</strong><br><br>
                    üìç <strong>H√¥tel Ibis Centre</strong> - 2km<br>
                    T√©l : 01 23 45 67 89<br><br>
                    üìç <strong>Best Western Rose</strong> - 3km<br>
                    T√©l : 01 23 45 67 90
                `
            },
            {
                id: 'dress_code',
                icon: 'üëî',
                title: 'Code vestimentaire',
                content: `
                    <strong>Tenue de soir√©e √©l√©gante</strong><br><br>
                    ‚Ä¢ Messieurs : Costume / Smoking<br>
                    ‚Ä¢ Mesdames : Robe de cocktail / Soir√©e<br><br>
                    üí° <em>Conseil :</em> Pr√©voyez des chaussures confortables pour danser !
                `
            },
            {
                id: 'contact',
                icon: 'üìû',
                title: 'Contact d\'urgence',
                content: `
                    <strong>Organisateurs :</strong><br>
                    Marie : 06 12 34 56 78<br>
                    Jean : 06 98 76 54 32
                `
            }
        ];

        let alertCheckInterval = null;

        // Fonction pour v√©rifier l'authentification
        function checkAuth() {
            const user = sessionStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'index.html';
                return null;
            }
            return JSON.parse(user);
        }

        // Fonction pour charger les alertes depuis l'API Python
        async function loadAlerts() {
            try {
                const response = await fetch('/api/info', {
                    cache: "no-store"
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Alertes charg√©es:', data.alerts.length);
                    return data.alerts || [];
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Impossible de charger les alertes:', error);
            }
            return [];
        }

        // Fonction pour formater la date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / 60000);
            
            if (diffMinutes < 1) {
                return "√Ä l'instant";
            } else if (diffMinutes < 60) {
                return `Il y a ${diffMinutes} min`;
            } else if (diffMinutes < 1440) {
                const hours = Math.floor(diffMinutes / 60);
                return `Il y a ${hours}h`;
            } else {
                return date.toLocaleDateString('fr-FR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        // Fonction pour afficher les alertes
        async function displayAlerts() {
            const alerts = await loadAlerts();
            const alertsSection = document.getElementById('alertsSection');
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsSection.style.display = 'none';
                return;
            }
            
            alertsSection.style.display = 'block';
            alertsList.innerHTML = '';
            
            // Trier par date d√©croissante
            alerts.sort((a, b) => b.timestamp - a.timestamp);
            
            alerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item';
                alertItem.innerHTML = `
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-time">
                        <span>‚è∞</span>
                        <span>${formatDate(alert.timestamp)}</span>
                    </div>
                `;
                alertsList.appendChild(alertItem);
            });
        }

        // Fonction pour afficher les informations statiques
        async function displayInfo() {
            const container = document.getElementById('infoContent');
            container.innerHTML = '';

            // Afficher chaque section
            DEFAULT_INFO.forEach(item => {
                const card = document.createElement('div');
                card.className = 'content-card';
                card.innerHTML = `
                    <h2>
                        <span style="font-size: 1.5em; margin-right: 10px;">${item.icon}</span>
                        ${item.title}
                    </h2>
                    <div style="color: #555; line-height: 1.8; margin-top: 15px;">
                        ${item.content}
                    </div>
                `;
                container.appendChild(card);
            });

            // Carte de remerciement
            const thanksCard = document.createElement('div');
            thanksCard.className = 'content-card';
            thanksCard.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            thanksCard.style.color = 'white';
            thanksCard.style.textAlign = 'center';
            thanksCard.innerHTML = `
                <h2 style="color: white;">üíï Merci d'√™tre avec nous</h2>
                <p style="font-size: 1.1em; color: rgba(255,255,255,0.9);">
                    Votre pr√©sence rend cette journ√©e encore plus sp√©ciale.<br>
                    Nous avons h√¢te de c√©l√©brer avec vous !
                </p>
            `;
            container.appendChild(thanksCard);
        }

        // Rafra√Æchir les alertes toutes les 10 secondes
        function startAlertPolling() {
            displayAlerts();
            
            alertCheckInterval = setInterval(() => {
                displayAlerts();
            }, 10000);
        }

        // Arr√™ter le polling
        window.addEventListener('beforeunload', () => {
            if (alertCheckInterval) {
                clearInterval(alertCheckInterval);
            }
        });

        // Initialisation
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÑ Page Info charg√©e');
            
            const user = checkAuth();
            if (!user) return;
            
            const token = sessionStorage.getItem('authToken');
            const backButton = document.getElementById('backButton');
            if (backButton && token) {
                backButton.href = `index.html?token=${token}`;
            }
            
            console.log('üë§ Utilisateur:', user.name);
            
            await displayAlerts();
            startAlertPolling();
            await displayInfo();
            
            console.log('‚úÖ Informations affich√©es');
        });
    </script>
</body>
</html>