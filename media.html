<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©dia - Mariage</title>
    <link rel="stylesheet" href="app.css">
    <style>
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .media-item {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .media-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }

        .media-info {
            padding: 15px;
        }

        .media-caption {
            color: #2c3e50;
            font-size: 1em;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .media-date {
            color: #7f8c8d;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 12px;
        }

        .download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .download-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .media-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-photo {
            background: #3498db;
            color: white;
        }

        .badge-video {
            background: #e74c3c;
            color: white;
        }

        .no-media {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            grid-column: 1/-1;
        }

        .no-media-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Modal lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .lightbox-content img,
        .lightbox-content video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 10px;
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .lightbox-close:hover {
            transform: scale(1.1);
        }

        .lightbox-caption {
            color: white;
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
        }

        .lightbox-download {
            position: absolute;
            top: -50px;
            left: 0;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lightbox-download:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .lightbox-nav:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .lightbox-prev {
            left: 20px;
        }

        .lightbox-next {
            right: 20px;
        }

        @media (max-width: 768px) {
            .media-grid {
                grid-template-columns: 1fr;
            }

            .lightbox-nav {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }

            .lightbox-prev {
                left: 10px;
            }

            .lightbox-next {
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="icon">üì∏</div>
            <h1>Galerie M√©dia</h1>
            <p class="subtitle">Revivez les meilleurs moments de cette journ√©e</p>
            <a href="#" id="backButton" class="back-button">‚Üê Retour √† l'accueil</a>
        </div>

        <div class="content-card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                <div>
                    <h2 style="margin-bottom: 10px;">üåü Photos & Vid√©os du Mariage</h2>
                    <p style="color: #7f8c8d;">
                        D√©couvrez les plus beaux souvenirs immortalis√©s lors de cette journ√©e sp√©ciale
                    </p>
                </div>
                <button onclick="downloadAllMedia()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s;" onmouseover="this.style.background='#229954'" onmouseout="this.style.background='#27ae60'">
                    <span>üì¶</span>
                    <span>T√©l√©charger tout</span>
                </button>
            </div>

            <div id="mediaGrid" class="media-grid">
                <div class="loading" style="text-align: center; padding: 40px; grid-column: 1/-1;">
                    <p>üîÑ Chargement des m√©dias...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox modal -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <button class="lightbox-nav lightbox-prev" onclick="event.stopPropagation(); navigateMedia(-1)">‚Äπ</button>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <button class="lightbox-download" onclick="event.stopPropagation(); downloadCurrentMedia()">
                <span>‚¨áÔ∏è</span>
                <span>T√©l√©charger</span>
            </button>
            <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
            <div id="lightboxMedia"></div>
            <div id="lightboxCaption" class="lightbox-caption"></div>
        </div>
        <button class="lightbox-nav lightbox-next" onclick="event.stopPropagation(); navigateMedia(1)">‚Ä∫</button>
    </div>

    <script>
        let allMedia = [];
        let currentMediaIndex = 0;

        // Fonction pour v√©rifier l'authentification
        function checkAuth() {
            const user = sessionStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'index.html';
                return null;
            }
            return JSON.parse(user);
        }

        // Fonction pour charger les m√©dias depuis l'API Python
        async function loadMedia() {
            try {
                const response = await fetch('/api/media', {
                    cache: "no-store",
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ M√©dias charg√©s:', data.media.length);
                    return data.media || [];
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Impossible de charger les m√©dias:', error);
            }
            return [];
        }

        // Fonction pour formater la date
        function formatDate(timestamp) {
            if (!timestamp) return 'Date inconnue';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / 60000);
            
            if (diffMinutes < 1) {
                return "√Ä l'instant";
            } else if (diffMinutes < 60) {
                return `Il y a ${diffMinutes} min`;
            } else if (diffMinutes < 1440) {
                const hours = Math.floor(diffMinutes / 60);
                return `Il y a ${hours}h`;
            } else {
                return date.toLocaleDateString('fr-FR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        // Fonction pour t√©l√©charger le m√©dia actuellement affich√© dans la lightbox
        function downloadCurrentMedia() {
            const media = allMedia[currentMediaIndex];
            downloadMedia(media);
        }

        // Fonction pour ouvrir la lightbox
        function openLightbox(index) {
            currentMediaIndex = index;
            displayLightboxMedia();
            
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.add('active');
        }

        // Fonction pour afficher le m√©dia dans la lightbox
        function displayLightboxMedia() {
            const media = allMedia[currentMediaIndex];
            const lightboxMedia = document.getElementById('lightboxMedia');
            const lightboxCaption = document.getElementById('lightboxCaption');
            
            const mediaPath = media.url || `media/${media.filename}`;
            
            if (media.type === 'image') {
                lightboxMedia.innerHTML = `<img src="${mediaPath}" alt="${media.caption || ''}" onerror="this.src='images/placeholder.png'">`;
            } else {
                lightboxMedia.innerHTML = `<video src="${mediaPath}" controls autoplay></video>`;
            }
            
            lightboxCaption.textContent = media.caption || media.filename;
        }

        // Fonction pour naviguer dans la lightbox
        function navigateMedia(direction) {
            currentMediaIndex += direction;
            
            // Boucle
            if (currentMediaIndex < 0) {
                currentMediaIndex = allMedia.length - 1;
            } else if (currentMediaIndex >= allMedia.length) {
                currentMediaIndex = 0;
            }
            
            displayLightboxMedia();
        }

        // Fonction pour fermer la lightbox
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            
            // Arr√™ter la vid√©o si c'est une vid√©o
            const video = lightbox.querySelector('video');
            if (video) {
                video.pause();
            }
        }

        // Fonction pour t√©l√©charger un m√©dia
        function downloadMedia(media) {
            const mediaPath = media.url || `media/${media.filename}`;
            const filename = media.filename;
            
            // Cr√©er un lien de t√©l√©chargement temporaire
            const a = document.createElement('a');
            a.href = mediaPath;
            a.download = filename;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log('üì• T√©l√©chargement lanc√©:', filename);
        }

        // Fonction pour t√©l√©charger tous les m√©dias
        async function downloadAllMedia() {
            if (allMedia.length === 0) {
                alert('Aucun m√©dia √† t√©l√©charger');
                return;
            }

            if (!confirm(`Voulez-vous t√©l√©charger tous les m√©dias ?\n\n${allMedia.length} fichier(s) seront t√©l√©charg√©s.`)) {
                return;
            }

            // T√©l√©charger chaque m√©dia avec un petit d√©lai
            for (let i = 0; i < allMedia.length; i++) {
                const media = allMedia[i];
                console.log(`üì• T√©l√©chargement ${i + 1}/${allMedia.length}: ${media.filename}`);
                downloadMedia(media);
                
                // Petit d√©lai entre chaque t√©l√©chargement
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            alert(`‚úÖ ${allMedia.length} fichier(s) t√©l√©charg√©s !\n\nV√©rifiez votre dossier de t√©l√©chargements.`);
        }

        // Fonction pour cr√©er une carte m√©dia
        function createMediaCard(media, index) {
            const card = document.createElement('div');
            card.className = 'media-item';
            
            const mediaPath = media.url || `media/${media.filename}`;
            
            const mediaElement = media.type === 'image' 
                ? `<img src="${mediaPath}" alt="${media.caption || ''}" onclick="openLightbox(${index})" onerror="this.src='images/placeholder.png'">`
                : `<video src="${mediaPath}" muted onclick="openLightbox(${index})"></video>`;
            
            const typeBadge = media.type === 'image'
                ? '<span class="media-type-badge badge-photo">üì∑ Photo</span>'
                : '<span class="media-type-badge badge-video">üé• Vid√©o</span>';
            
            card.innerHTML = `
                ${mediaElement}
                <div class="media-info">
                    <div class="media-caption">
                        ${media.caption || media.filename}
                        ${typeBadge}
                    </div>
                    <div class="media-date">
                        <span>‚è∞</span>
                        <span>${formatDate(media.timestamp)}</span>
                    </div>
                    <button class="download-btn" onclick="event.stopPropagation(); downloadMedia(${JSON.stringify(media).replace(/"/g, '&quot;')})">
                        <span>‚¨áÔ∏è</span>
                        <span>T√©l√©charger</span>
                    </button>
                </div>
            `;
            
            return card;
        }

        // Fonction pour afficher les m√©dias
        async function displayMedia() {
            const grid = document.getElementById('mediaGrid');
            allMedia = await loadMedia();
            
            grid.innerHTML = '';
            
            if (allMedia.length === 0) {
                grid.innerHTML = `
                    <div class="no-media">
                        <div class="no-media-icon">üì∏</div>
                        <h3>Aucun m√©dia pour le moment</h3>
                        <p>Les photos et vid√©os appara√Ætront ici au fur et √† mesure</p>
                    </div>
                `;
                return;
            }
            
            // Trier par date d√©croissante
            allMedia.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            allMedia.forEach((media, index) => {
                const card = createMediaCard(media, index);
                grid.appendChild(card);
            });
        }

        // Rafra√Æchir les m√©dias toutes les 30 secondes
        let refreshInterval;
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                displayMedia();
            }, 30000);
        }

        // Arr√™ter le rafra√Æchissement quand on quitte la page
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // Fermer la lightbox avec la touche √âchap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                navigateMedia(-1);
            } else if (e.key === 'ArrowRight') {
                navigateMedia(1);
            }
        });

        // Initialisation de la page
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÑ Page M√©dia charg√©e');
            
            // V√©rifier l'authentification
            const user = checkAuth();
            if (!user) {
                return;
            }
            
            // Configurer le bouton retour
            const token = sessionStorage.getItem('authToken');
            const backButton = document.getElementById('backButton');
            if (backButton && token) {
                backButton.href = `index.html?token=${token}`;
            }
            
            console.log('üë§ Utilisateur:', user.name);
            
            // Afficher les m√©dias
            await displayMedia();
            
            // D√©marrer le rafra√Æchissement automatique
            startAutoRefresh();
            
            console.log('‚úÖ M√©dias affich√©s');
        });
    </script>
</body>
</html>